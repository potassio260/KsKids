<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ks Kids Shop</title>
  <link rel="stylesheet" href="css/main.css">
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
    <div class="topbar-section left">
        <div class="buttons" onclick="toggleMenu()">
            <img src="icons\menu.png" alt="" class="button-images">
        </div>
        <h1>Ks kids</h1>
    </div>

    <div class="topbar-section center">
        <div class="search-bar">
            <input type="text" placeholder="Buscar..." class="search-input" id="searchInput" />
            <div class="search" onclick="performSearch()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
            </div>
        </div>
    </div>

    <div class="topbar-section right">
        <div class="buttons" onclick="showNotification('¬°Tienes 3 notificaciones nuevas!')">
            
          <img src="icons\notification-bell.png" alt="" class="button-images">
            
        </div>
        <div class="buttons" style="margin: 0 15px;" onclick="openContactModal()">
            <img src="icons\customer-service.png" alt="" class="button-images">
        </div>
    </div>
</div>

<!-- CATEGORY NAVIGATION -->
<div class="category-nav" id="categoryNav">
    <div class="category-nav-container" id="categoryContainer">
        <div class="category-item active" onclick="selectCategory(this, 'todos')" data-category="todos">
            <span class="category-icon">üè†</span>
            Todos
        </div>
        <div class="category-item" onclick="selectCategory(this, 'ropa-bebe')" data-category="ropa-bebe">
            <span class="category-icon">üë∂</span>
            Ropa de beb√©
        </div>
        <div class="category-item" onclick="selectCategory(this, 'ni√±os')" data-category="ni√±os">
            <span class="category-icon">üëß</span>
            De ni√±os/as
        </div>
        <div class="category-item" onclick="selectCategory(this, 'chicos')" data-category="chicos">
            <span class="category-icon">üßí</span>
            De chicos/as
        </div>
        <div class="category-item" onclick="selectCategory(this, 'accesorio')" data-category="accesorios">
            <span class="category-icon">üìø</span>
            Accesorios
        </div>
        <div class="category-item" onclick="selectCategory(this, 'juguetes')" data-category="juguetes">
            <span class="category-icon">üß∏</span>
            Juguetes
        </div>
        <div class="category-item" onclick="selectCategory(this, 'calzado')" data-category="calzado">
            <span class="category-icon">üëü</span>
            Calzado
        </div>
        <div class="category-item" onclick="selectCategory(this, 'verano')" data-category="verano">
            <span class="category-icon">üèñÔ∏è</span>
            Verano
        </div>
        <div class="category-item" onclick="selectCategory(this, 'invierno')" data-category="invierno">
            <span class="category-icon">üß£</span>
            Invierno
        </div>
    </div>
</div>

<!-- MENU OVERLAY -->
<div class="menu-backdrop" id="menuBackdrop" onclick="toggleMenu()"></div>
<div class="menu-overlay" id="menuOverlay">
    <!-- Categories will be populated here on mobile -->
</div>

<!-- NOTIFICATION -->
<div class="notification" id="notification"></div>

<!-- CONTACT MODAL -->
<div class="contact-modal" id="contactModal">
    <div class="contact-modal-content">
        <div class="contact-modal-header">
            <h2>üìû Cont√°ctanos</h2>
            <button class="close-contact-modal" onclick="closeContactModal()">&times;</button>
        </div>
        <div class="contact-modal-body">
            <div class="contact-info">
                <div class="contact-item">
                    <div class="contact-icon">üìß</div>
                    <div class="contact-details">
                        <h3>Email</h3>
                        <p>olifkskids@gmail.com</p>
                        <a href="mailto:olifkskids@gmail.com" class="contact-btn">Enviar Email</a>
                    </div>
                </div>
                
                <div class="contact-item">
                    <div class="contact-icon">üì±</div>
                    <div class="contact-details">
                        <h3>Tel√©fono</h3>
                        <p>+34 697 20 84 76</p>
                        <a href="tel:+34697208476" class="contact-btn">Llamar Ahora</a>
                    </div>
                </div>
                
                <div class="contact-item">
                    <div class="contact-icon">üí¨</div>
                    <div class="contact-details">
                        <h3>WhatsApp</h3>
                        <p>Respuesta inmediata</p>
                        <a href="https://wa.me/34697208476" target="_blank" class="contact-btn">Abrir WhatsApp</a>
                    </div>
                </div>
                
                <div class="contact-item">
                    <div class="contact-icon">üìç</div>
                    <div class="contact-details">
                        <h3>Ubicaci√≥n</h3>
                        <p>Beniel, Spain</p>
                        <p class="contact-address">c. Francisco Robles 19</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
  <div class="main">
    <!-- PRODUCT INFO MODAL -->
    <div class="product-info-modal" id="productInfoModal">
        <div class="product-info-content">
            <div class="product-info-header">
                <img src="" alt="" class="product-info-image" id="modalProductImage">
                <button class="close-modal" onclick="closeProductInfo()">&times;</button>
            </div>
            <div class="product-info-body">
                <h2 class="product-info-title" id="modalProductTitle">Product Name</h2>
                <div class="product-info-price" id="modalProductPrice">‚Ç¨0.00</div>
                <p class="product-info-description" id="modalProductDescription">Product description goes here...</p>
                
                <div class="product-info-details">
                    <div class="product-detail">
                        <div class="product-detail-label">Categor√≠a</div>
                        <div class="product-detail-value" id="modalProductCategory">Category</div>
                    </div>
                    <div class="product-detail">
                        <div class="product-detail-label">Stock</div>
                        <div class="product-detail-value">
                            <span class="stock-indicator" id="modalProductStock">Available</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Discount Banner -->
    <div class="discount-banner">
      <div class="discount-title">¬°Descuentos!</div>
    </div>
   <!-- Product Carousel -->
    <div class="product-carousel" id="productCarousel">
      <button class="arrow-btn prev" onclick="previousProduct()">‚Äπ</button>
  
      <div class="carousel-container">
        <img src="images/516204036_1213616423896700_999017950145108751_n.jpg" class="side-image" id="sideLeft" alt="Previous" />
        
        <div class="main-product">
          <div class="main-imagebox" id="mainImageBox">
            <img src="images/516891834_1213616377230038_4997410880746407739_n.jpg" alt="Producto principal" class="main-image" id="mainImage" />
            <div class="product-info">
              <div class="product-title" id="productTitle">Cargando...</div>
              <div class="product-price" id="productPrice">-</div>
            </div>
          </div>
        </div>
    
        <img src="images/518084926_1213616383896704_1024783052948639362_n.jpg" class="side-image" id="sideRight" alt="Next" />
      </div>

      <button class="arrow-btn next" onclick="nextProduct()">‚Ä∫</button>
    </div>
  
    <div class="divider-line"></div>
    <!-- Products Grid -->
    <div class="products-grid"></div>
  </div>
  <footer class="footer">
        <div class="floating-shapes">
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
        </div>
        
        <div class="footer-content">
            <div class="footer-top">
                <div class="footer-section">
                    <h3>Empresa</h3>
                    <ul>
                        <li><a href="https://www.facebook.com/p/KS-kids-100057450610975/?_rdr">Acerca de Nosotros</a></li> 
                        <li><a href="https://www.flaticon.com/">Uso de Iconos</a></li>
                        <li><a href="https://www.flaticon.com/free-icons/notification" title="notification icons">Notification icons created by ghufronagustian - Flaticon</a></li>
                        <li><a href="https://www.flaticon.com/free-icons/customer-service" title="customer service icons">Customer service icons created by Freepik - Flaticon</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>Productos</h3>
                    <ul>
                        <li><a href="#">Caracter√≠sticas</a></li>
                        <li><a href="#">Precios</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>Soporte</h3>
                    <ul>
                        <li><a href="#">Centro de Ayuda</a></li>
                        <li><a onclick="openContactModal()">Cont√°ctanos</a></li>
                        <li><a href="#">Reportar Errores</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <div class="newsletter">
                        <h3>Mantente Actualizado</h3>
                        <p style="color: #b0b0b0; margin-bottom: 1rem; font-size: 0.9rem;">Recibe las √∫ltimas noticias y actualizaciones en tu bandeja de entrada.</p>
                        <div class="newsletter-input">
                            <input type="email" placeholder="Ingresa tu email" id="emailInput">
                            <button id="subscribeBtn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="social-links">
                       <a href="https://www.facebook.com/people/KS-kids/100057450610975/?sk=following" class="social-link" title="Facebook">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </a>
                        <a href="#" class="social-link" title="TikTok">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/>
                            </svg>
                        </a>
                        <a href="#" class="social-link" title="GitHub">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                        </a>
                        <a href="#" class="social-link" title="Instagram">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 KsKids.</p>
                <div class="links">
                </div>
            </div>
        </div>
    </footer>

<script>

    // Contact Modal Functions
    function openContactModal() {
        const modal = document.getElementById('contactModal');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeContactModal() {
        const modal = document.getElementById('contactModal');
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }

    // Close contact modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('contactModal');
        if (e.target === modal) {
            closeContactModal();
        }
    });

    // Close contact modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('contactModal').classList.contains('show')) {
            closeContactModal();
        }
    });

    const emailInput = document.getElementById('emailInput');
      const subscribeBtn = document.getElementById('subscribeBtn');

      emailInput.addEventListener('input', function() {
          if (this.value.trim() !== '') {
              subscribeBtn.classList.add('active');
          } else {
              subscribeBtn.classList.remove('active');
          }
      });
    
    let products = [];
    let discountedProducts = [];

    // Function to load products from Firebase
    async function loadProductsFromFirebase() {
        try {
            showNotification('Cargando productos...');
            const querySnapshot = await window.firestoreFunctions.getDocs(
            window.firestoreFunctions.collection(window.db, 'products')
            );
            
            products = [];
            querySnapshot.forEach((doc) => {
            const data = doc.data();
            
            // Calculate discounted price if discount exists
            const originalPrice = data.rawPrice || 0;
            const discountPercent = data.discount || 0;
            const discountedPrice = discountPercent > 0 
                ? originalPrice * (1 - discountPercent / 100)
                : originalPrice;
            
            // Determine hasDiscount based on discount percentage or explicit hasDiscount field
            const hasDiscount = data.hasDiscount !== undefined 
                ? data.hasDiscount 
                : (discountPercent > 0);
            
            products.push({
                id: doc.id,
                name: data.name || 'Producto sin nombre',
                price: data.price || '‚Ç¨0,00', // Use formatted price string
                rawPrice: originalPrice, // Keep raw price for calculations
                discount: discountPercent,
                hasDiscount: hasDiscount, // Use the boolean field
                discountedPrice: discountedPrice,
                formattedDiscountedPrice: `‚Ç¨${discountedPrice.toFixed(2)}`, // Format discounted price
                image: data.image || data.imageUrl || 'images/default-product.jpg', // Use Cloudinary URL
                category: data.category || 'todos',
                description: data.description || 'Sin descripci√≥n disponible',
                stock: data.stock || 0,
                minStock: data.minStock || 0,
                featured: data.featured || false,
                sku: data.sku || '',
                cloudinaryPublicId: data.cloudinaryPublicId || '',
                imageName: data.imageName || '',
                createdAt: data.createdAt || null,
                updatedAt: data.updatedAt || null
            });
            });
            
            // Filter products with hasDiscount = true for carousel (must also have stock)
            discountedProducts = products.filter(product => product.hasDiscount === true && product.stock > 0);
            
            // Hide/show discount elements based on discounted products
            const discountBanner = document.querySelector('.discount-banner');
            const dividerLine = document.querySelector('.divider-line');
            const carousel = document.querySelector('.product-carousel');
            
            if (discountedProducts.length > 0) {
            if (discountBanner) discountBanner.style.display = 'block';
            if (dividerLine) dividerLine.style.display = 'block';
            if (carousel) carousel.style.display = 'block';
            
            // Reset carousel index if it's out of bounds
            if (currentProductIndex >= discountedProducts.length) {
                currentProductIndex = 0;
            }
            
            // Update carousel with discounted products and grid with all products
            if (typeof updateProduct === 'function') updateProduct();
            if (typeof updateProductsGrid === 'function') updateProductsGrid();
            showNotification(`${products.length} productos cargados, ${discountedProducts.length} con descuento`);
            } else {
            if (discountBanner) discountBanner.style.display = 'none';
            if (dividerLine) dividerLine.style.display = 'none';
            if (carousel) carousel.style.display = 'none';
            
            // Still show all products in grid
            if (typeof updateProductsGrid === 'function') updateProductsGrid();
            showNotification(`${products.length} productos cargados (sin descuentos)`);
            }
            
            if (products.length === 0) {
            showNotification('No se encontraron productos');
            }
            
        } catch (error) {
            console.error('Error loading products:', error);
            showNotification('Error al cargar productos: ' + error.message);
        }
    }

    // Modified JavaScript Functions
    let currentSelectedProduct = null;

    function openProductInfo(product) {
        currentSelectedProduct = product;
        const modal = document.getElementById('productInfoModal');
        const modalImage = document.getElementById('modalProductImage');
        const modalTitle = document.getElementById('modalProductTitle');
        const modalPrice = document.getElementById('modalProductPrice');
        const modalDescription = document.getElementById('modalProductDescription');
        const modalCategory = document.getElementById('modalProductCategory');
        const modalStock = document.getElementById('modalProductStock');

        // Populate modal with product data
        modalImage.src = product.image;
        modalImage.alt = product.name;
        modalTitle.textContent = product.name;
        modalDescription.textContent = product.description;
        modalCategory.textContent = product.category;

        // Handle pricing - use hasDiscount boolean
        if (product.hasDiscount && product.discount > 0) {
            modalPrice.innerHTML = `<span class="original-price">${product.price}</span><span class="discounted-price">${product.formattedDiscountedPrice}</span>`;
        } else {
            modalPrice.innerHTML = product.price;
        }

        // Handle stock status - Modified to not show specific numbers when low stock
        const stockStatus = product.stock > 10 ? 'in-stock' : 
                        product.stock > 0 ? 'low-stock' : 'out-of-stock';
        const stockText = product.stock > 10 ? 'En Stock' : 
                        product.stock > 0 ? 'Stock Limitado' : 'Agotado'; // Changed to not show specific number
        
        modalStock.className = `stock-indicator ${stockStatus}`;
        modalStock.textContent = stockText;

        // Show modal with animation
        modal.classList.add('show');
        document.body.style.overflow = 'hidden'; // Prevent background scroll
    }

    function closeProductInfo() {
        const modal = document.getElementById('productInfoModal');
        modal.classList.remove('show');
        document.body.style.overflow = ''; // Restore scroll
        currentSelectedProduct = null;
    }

    function addToCart() {
        if (currentSelectedProduct && currentSelectedProduct.stock > 0) {
            showNotification(`"${currentSelectedProduct.name}" a√±adido al carrito`);
            closeProductInfo();
        }
    }

    function addToWishlist() {
        if (currentSelectedProduct) {
            showNotification(`"${currentSelectedProduct.name}" a√±adido a favoritos`);
        }
    }

    // Close modal when clicking outside
    document.getElementById('productInfoModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeProductInfo();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('productInfoModal').classList.contains('show')) {
            closeProductInfo();
        }
    });

    let isMenuOpen = false;
    let currentProductIndex = 0;
    let isTransitioning = false;

    // Touch handling for carousel
    let startX = 0;
    let startY = 0;
    let isDragging = false;

    // Notification system
    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Updated to use hasDiscount boolean
    function hasDiscountedProducts() {
      return products.some(product => product.hasDiscount === true);
    }

    function updateProductsGrid() {
      const productsGrid = document.querySelector('.products-grid');
      productsGrid.innerHTML = ''; // Clear existing products
      
      // Show ALL products in the grid (not just discounted ones)
      products.forEach(product => {
        const productBox = document.createElement('div');
        productBox.className = 'product-box';
        productBox.setAttribute('data-category', product.category);
        
        const stockStatus = product.stock > 10 ? 'in-stock' : 
                          product.stock > 0 ? 'low-stock' : 'out-of-stock';
        const stockText = product.stock > 10 ? 'En stock' : 
                          product.stock > 0 ? 'Pocos' : 'Agotado';
        
        // Use hasDiscount boolean for price display
        const priceDisplay = product.hasDiscount && product.discount > 0
          ? `<span class="original-price" style="text-decoration: line-through; margin-right: 5px;">${product.price}</span><span style="color: #ff6b6b;">${product.formattedDiscountedPrice}</span>`
          : product.price;

        productBox.innerHTML = `
          <div class="product-image">
            <img src="${product.image}" alt="${product.name}" />
            <div class="price-badge">${product.hasDiscount && product.discount > 0 ? product.formattedDiscountedPrice : product.price}</div>
            <div class="stock-status ${stockStatus}">${stockText}</div>
          </div>
          <div class="product-content">
            <h3 class="product-name">${product.name}</h3>
            <p class="product-description">${product.description}</p>
            <span class="product-category">${product.category}</span>
          </div>
        `;
        
        productsGrid.appendChild(productBox);
      });
      
      // Reinitialize product click handlers
      initializeProductClicks();
    }
    
    // Product carousel functionality - Updated to use hasDiscount boolean
    function updateProduct() {
      if (isTransitioning || discountedProducts.length === 0) return;
      isTransitioning = true;

      // Use discountedProducts array for carousel (filtered by hasDiscount = true)
      const product = discountedProducts[currentProductIndex];
      const prevIndex = (currentProductIndex - 1 + discountedProducts.length) % discountedProducts.length;
      const nextIndex = (currentProductIndex + 1) % discountedProducts.length;

      // Update main product with smooth transition
      const mainImage = document.getElementById('mainImage');
      const productTitle = document.getElementById('productTitle');
      const productPrice = document.getElementById('productPrice');
      const sideLeft = document.getElementById('sideLeft');
      const sideRight = document.getElementById('sideRight');

      // Fade out
      mainImage.style.opacity = '0';
      
      setTimeout(() => {
        // Update content
        mainImage.src = product.image;
        mainImage.alt = product.name;
        productTitle.textContent = product.name;
        
        // Show both prices since these products have hasDiscount = true
        if (product.hasDiscount && product.discount > 0) {
            productPrice.innerHTML = `<span class="original-price">${product.price}</span><span class="discounted-price">${product.formattedDiscountedPrice}</span>`;
        } else {
            // Fallback if somehow a product without discount got into discountedProducts
            productPrice.innerHTML = product.price;
        }
        
        // Update side images
        sideLeft.src = discountedProducts[prevIndex].image.replace('300&h=400', '120&h=160');
        sideRight.src = discountedProducts[nextIndex].image.replace('300&h=400', '120&h=160');
        
        // Fade in
        setTimeout(() => {
          mainImage.style.opacity = '1';
        }, 50);
        isTransitioning = false;
      }, 300);
    }

    function nextProduct() {
      if (isTransitioning || discountedProducts.length === 0) return;
      currentProductIndex = (currentProductIndex + 1) % discountedProducts.length;
      updateProduct();
    }

    function previousProduct() {
      if (isTransitioning || discountedProducts.length === 0) return;
      currentProductIndex = (currentProductIndex - 1 + discountedProducts.length) % discountedProducts.length;
      updateProduct();
    }

    // Touch events for carousel swipe
    function initializeSwipe() {
      const carousel = document.getElementById('productCarousel');
      
      carousel.addEventListener('touchstart', handleTouchStart, { passive: true });
      carousel.addEventListener('touchmove', handleTouchMove, { passive: false });
      carousel.addEventListener('touchend', handleTouchEnd, { passive: true });
    }

    function handleTouchStart(e) {
      const touch = e.touches[0];
      startX = touch.clientX;
      startY = touch.clientY;
      isDragging = true;
    }

    function handleTouchMove(e) {
      if (!isDragging) return;
      
      const touch = e.touches[0];
      const deltaX = touch.clientX - startX;
      const deltaY = Math.abs(touch.clientY - startY);
      
      // Prevent scrolling if horizontal swipe
      if (Math.abs(deltaX) > deltaY && Math.abs(deltaX) > 20) {
        e.preventDefault();
      }
    }

    function handleTouchEnd(e) {
      if (!isDragging) return;
      
      const touch = e.changedTouches[0];
      const deltaX = touch.clientX - startX;
      const deltaY = Math.abs(touch.clientY - startY);
      
      // Check if it's a horizontal swipe
      if (Math.abs(deltaX) > 50 && Math.abs(deltaX) > deltaY) {
        if (deltaX > 0) {
          previousProduct();
        } else {
          nextProduct();
        }
      }
      
      isDragging = false;
    }

    // Auto-rotate carousel
    function startAutoRotate() {
      setInterval(() => {
        if (!isTransitioning && !isDragging) {
          nextProduct();
        }
      }, 5000);
    }

    // Click handlers for side images
    function initializeSideImageClicks() {
        const sideLeft = document.getElementById('sideLeft');
        const sideRight = document.getElementById('sideRight');
        const mainImage = document.getElementById('mainImage');
        
        sideLeft.addEventListener('click', previousProduct);
        sideRight.addEventListener('click', nextProduct);
        
        // Add click handler for main carousel image
        mainImage.addEventListener('click', () => {
            if (discountedProducts.length > 0) {
                const currentProduct = discountedProducts[currentProductIndex];
                openProductInfo(currentProduct);
            }
        });
        
        // Make main image appear clickable
        mainImage.style.cursor = 'pointer';
    }

    // Product box click handlers
    function initializeProductClicks() {
        const productBoxes = document.querySelectorAll('.product-box');
        productBoxes.forEach((box, index) => {
            box.addEventListener('click', () => {
                const productName = box.querySelector('.product-name').textContent;
                // Find the product in our products array
                const product = products.find(p => p.name === productName);
                if (product) {
                    openProductInfo(product);
                }
            });
        });
    }

    // Handle window resize
    window.addEventListener('resize', function() {
      // Adjust carousel for orientation changes
      if (window.innerWidth <= 870) {
        const sideImages = document.querySelectorAll('.side-image');
        sideImages.forEach(img => img.style.display = 'none');
      } else {
        const sideImages = document.querySelectorAll('.side-image');
        sideImages.forEach(img => img.style.display = 'block');
      }
    });

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Load products from Firebase first
      loadProductsFromFirebase();
      
      // Initialize other functionality
      initializeSwipe();
      initializeSideImageClicks();
      startAutoRotate();
      
      // Add loading animation
      document.body.style.opacity = '0';
      setTimeout(() => {
        document.body.style.transition = 'opacity 0.5s ease';
        document.body.style.opacity = '1';
      }, 100);
    });

    const categories = [
        { id: 'todos', icon: 'üè†', name: 'Todos' },
        { id: 'ropa-bebe', icon: 'üë∂', name: 'Ropa de beb√©' },
        { id: 'ni√±os', icon: 'üëß', name: 'De ni√±os/as' },
        { id: 'chicos', icon: 'üßí', name: 'De chicos/as' },
        { id: 'accesorio', icon: 'üìø', name: 'Accesorios' },
        { id: 'juguetes', icon: 'üß∏', name: 'Juguetes' },
        { id: 'calzado', icon: 'üëü', name: 'Calzado' },
        { id: 'toallas-gorras-banadores', icon: 'üèñÔ∏è', name: 'Verano' },
        { id: 'invierno', icon: 'üß£', name: 'Invierno' }
    ];

    // Check if we should show categories in menu (mobile view)
    function shouldShowCategoriesInMenu() {
        return window.innerWidth <= 1320;
    }
    // Populate menu with categories on mobile
    function populateMenu() {
        const menuOverlay = document.getElementById('menuOverlay');
        
        if (shouldShowCategoriesInMenu()) {
            // Clear existing content and add categories
            menuOverlay.innerHTML = '';
            
            categories.forEach(category => {
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.innerHTML = `${category.icon} ${category.name}`;
                menuItem.onclick = () => {
                    selectCategoryFromMenu(category.id, category.name);
                };
                menuOverlay.appendChild(menuItem);
            });
        } else {
            // On desktop, menu is empty as requested
            menuOverlay.innerHTML = '';
        }
    }

    // Handle category selection from menu
    function selectCategoryFromMenu(categoryId, categoryName) {
        // Update desktop category if visible
        if (!shouldShowCategoriesInMenu()) {
            const categoryElements = document.querySelectorAll('.category-item');
            categoryElements.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-category') === categoryId) {
                    item.classList.add('active');
                }
            });
        }
        
        // Filter products
        filterProducts(categoryId);
        
        showNotification(`Filtered by: ${categoryName}`);
        toggleMenu();
    }

    function filterProducts(categoryId) {
      const productBoxes = document.querySelectorAll('.product-box');
      const productsGrid = document.querySelector('.products-grid');
      let visibleCount = 0;
      
      // Remove any existing "no products" message
      const existingNoProducts = document.querySelector('.no-products');
      if (existingNoProducts) {
          existingNoProducts.remove();
      }
      
      // First, add filtering-out class to boxes that will be hidden
      productBoxes.forEach(box => {
          const productCategory = box.getAttribute('data-category');
          removeHighlight(box);
          
          if (categoryId === 'todos' || productCategory === categoryId) {
              box.classList.remove('filtering-out');
              visibleCount++;
          } else {
              box.classList.add('filtering-out');
          }
      });
      
      // After animation, actually hide the boxes
      setTimeout(() => {
          productBoxes.forEach(box => {
              const productCategory = box.getAttribute('data-category');
              if (categoryId === 'todos' || productCategory === categoryId) {
                  box.style.display = 'block';
              } else {
                  box.style.display = 'none';
                  box.classList.remove('filtering-out');
              }
          });
      }, 300); // Match the transition duration
      
      // Show message if no products found
      if (visibleCount === 0) {
          setTimeout(() => {
              const noProductsDiv = document.createElement('div');
              noProductsDiv.className = 'no-products';
              noProductsDiv.textContent = 'No hay productos disponibles en esta categor√≠a';
              noProductsDiv.style.opacity = '0';
              noProductsDiv.style.transform = 'translateY(20px)';
              noProductsDiv.style.transition = 'all 0.3s ease';
              productsGrid.appendChild(noProductsDiv);
              
              setTimeout(() => {
                  noProductsDiv.style.opacity = '1';
                  noProductsDiv.style.transform = 'translateY(0)';
              }, 50);
          }, 300);
      }
  }

    // Menu functionality
    function toggleMenu() {
        isMenuOpen = !isMenuOpen;
        const menuOverlay = document.getElementById('menuOverlay');
        const menuBackdrop = document.getElementById('menuBackdrop');
        
        // Populate menu content based on screen size
        populateMenu();
        
        if (isMenuOpen) {
            menuOverlay.classList.add('open');
            menuBackdrop.classList.add('open');
        } else {
            menuOverlay.classList.remove('open');
            menuBackdrop.classList.remove('open');
        }
    }

    // Category selection
    function selectCategory(element, categoryId) {
        // Remove active class from all categories
        const allCategories = document.querySelectorAll('.category-item');
        allCategories.forEach(item => item.classList.remove('active'));
        
        // Add active class to clicked category
        element.classList.add('active');
        
        // Filter products
        filterProducts(categoryId);
        
        // Show notification with selected category
        const categoryName = element.textContent.trim();
        showNotification(`Filtered by: ${categoryName}`);
        
        // Scroll the selected category into view
        element.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest',
            inline: 'center'
        });
    }

    // Category scrolling functionality
    function scrollCategories(direction) {
        const container = document.getElementById('categoryContainer');
        const scrollAmount = 200;
        
        if (direction === 1) {
            container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        } else {
            container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        }
        
        // Update scroll indicators
        setTimeout(updateScrollIndicators, 300);
    }

    // Update scroll indicators visibility
    function updateScrollIndicators() {
        const container = document.getElementById('categoryContainer');
        const leftIndicator = document.getElementById('scrollLeft');
        const rightIndicator = document.getElementById('scrollRight');
        
        if (container.scrollLeft <= 10) {
            leftIndicator.style.opacity = '0.3';
            leftIndicator.style.pointerEvents = 'none';
        } else {
            leftIndicator.style.opacity = '1';
            leftIndicator.style.pointerEvents = 'auto';
        }
        
        if (container.scrollLeft >= container.scrollWidth - container.clientWidth - 10) {
            rightIndicator.style.opacity = '0.3';
            rightIndicator.style.pointerEvents = 'none';
        } else {
            rightIndicator.style.opacity = '1';
            rightIndicator.style.pointerEvents = 'auto';
        }
    }

    // Navigation
    function navigateTo(section) {
        showNotification(`Navigating to ${section}...`);
        toggleMenu();
        
        // Add loading state
        document.body.classList.add('loading');
        setTimeout(() => {
            document.body.classList.remove('loading');
        }, 1000);
    }

    // Search functionality
    function performSearch() {
      const searchInput = document.getElementById('searchInput');
      const query = searchInput.value.trim().toLowerCase();
      
      if (query) {
          showNotification(`Buscando: "${query}"`);
          
          // Filter products based on search query
          const productBoxes = document.querySelectorAll('.product-box');
          const productsGrid = document.querySelector('.products-grid');
          let visibleCount = 0;
          
          // Remove any existing "no products" message
          const existingNoProducts = document.querySelector('.no-products');
          if (existingNoProducts) {
              existingNoProducts.remove();
          }
          
          // Reset category selection to show search results
          const allCategories = document.querySelectorAll('.category-item');
          allCategories.forEach(item => item.classList.remove('active'));
          // Set "Todos" as active during search
          const todosCategory = document.querySelector('[data-category="todos"]');
          if (todosCategory) {
              todosCategory.classList.add('active');
          }
          
          productBoxes.forEach(box => {
            const productName = box.querySelector('.product-name').textContent.toLowerCase();
            const productDescription = box.querySelector('.product-description').textContent.toLowerCase();
            const productCategory = box.querySelector('.product-category').textContent.toLowerCase();
            
            if (productName.includes(query) || 
                productDescription.includes(query) || 
                productCategory.includes(query)) {
                box.classList.remove('filtering-out');
                highlightSearchTerm(box, query);
                visibleCount++;
            } else {
                box.classList.add('filtering-out');
                removeHighlight(box);
            }
        });

        // After animation, actually hide the boxes
        setTimeout(() => {
            productBoxes.forEach(box => {
                const productName = box.querySelector('.product-name').textContent.toLowerCase();
                const productDescription = box.querySelector('.product-description').textContent.toLowerCase();
                const productCategory = box.querySelector('.product-category').textContent.toLowerCase();
                
                if (productName.includes(query) || 
                    productDescription.includes(query) || 
                    productCategory.includes(query)) {
                    box.classList.remove('hidden');
                } else {
                    box.classList.add('hidden');
                    box.classList.remove('filtering-out');
                }
            });
        }, 300);
          
          // Show message if no products found
          if (visibleCount === 0) {
              const noProductsDiv = document.createElement('div');
              noProductsDiv.className = 'no-products';
              noProductsDiv.innerHTML = `No se encontraron productos para: "<strong>${query}</strong>"`;
              productsGrid.appendChild(noProductsDiv);
          } else {
              showNotification(`${visibleCount} productos encontrados`);
          }
          
          // Clear search input after search
          searchInput.value = '';
          
          // Add visual feedback to search button
          const searchButton = document.querySelector('.search');
          searchButton.style.opacity = '0.5';
          setTimeout(() => {
              searchButton.style.opacity = '1';
          }, 500);
          
      } else {
          showNotification('Por favor ingresa un t√©rmino de b√∫squeda');
          // If empty search, show all products
          showAllProducts();
      }
  }

  // Fix mobile keyboard issues
    document.getElementById('searchInput').addEventListener('focus', function() {
        // Small delay to ensure proper keyboard behavior
        setTimeout(() => {
            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
    });

  // Helper function to highlight search terms
  function highlightSearchTerm(productBox, query) {
      const productName = productBox.querySelector('.product-name');
      const originalText = productName.textContent;
      const highlightedText = originalText.replace(
          new RegExp(`(${query})`, 'gi'), 
          '<span style="background-color: none; color: black;">$1</span>'
      );
      productName.innerHTML = highlightedText;
  }

  // Helper function to remove highlighting
  function removeHighlight(productBox) {
      const productName = productBox.querySelector('.product-name');
      productName.innerHTML = productName.textContent; // Remove any HTML tags
  }

  // Helper function to show all products (reset search)
  function showAllProducts() {
      const productBoxes = document.querySelectorAll('.product-box');
      productBoxes.forEach(box => {
          box.classList.remove('hidden');
          removeHighlight(box);
      });
      
      // Remove "no products" message
      const existingNoProducts = document.querySelector('.no-products');
      if (existingNoProducts) {
          existingNoProducts.remove();
      }
  }

  // Add a clear search function (optional)
  function clearSearch() {
      document.getElementById('searchInput').value = '';
      showAllProducts();
      showNotification('B√∫squeda limpiada');
  }

    // Search on Enter key
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    // Notification system
    function showNotification(message) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
        if (isMenuOpen && !e.target.closest('.menu-overlay') && !e.target.closest('.buttons')) {
            toggleMenu();
        }
    });

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isMenuOpen) {
            toggleMenu();
        }
    });

    // Mobile sidebar touch support
    let sidebarTouchStartX = 0;
    let sidebarTouchStartY = 0;
    let isSidebarSwipeActive = false;

    function handleSidebarTouchStart(e) {
        // Don't interfere with search bar or other interactive elements
        if (e.target.closest('.search-bar') || 
            e.target.closest('.buttons') || 
            e.target.closest('input')) {
            return;
        }
        
        const touch = e.touches[0];
        sidebarTouchStartX = touch.clientX;
        sidebarTouchStartY = touch.clientY;
        isSidebarSwipeActive = true;
    }

    function handleSidebarTouchMove(e) {
        if (!isSidebarSwipeActive || !isMenuOpen) return;
        
        // Don't interfere with search bar
        if (e.target.closest('.search-bar')) return;
        
        const touch = e.touches[0];
        const deltaX = touch.clientX - sidebarTouchStartX;
        const deltaY = Math.abs(touch.clientY - sidebarTouchStartY);
        
        if (deltaX < -30 && deltaY < 50) {
            e.preventDefault();
        }
    }


    function handleSidebarTouchEnd(e) {
        if (!isSidebarSwipeActive || !isMenuOpen) return;
        
        const touch = e.changedTouches[0];
        const deltaX = touch.clientX - sidebarTouchStartX;
        const deltaY = Math.abs(touch.clientY - sidebarTouchStartY);
        
        if (deltaX < -50 && deltaY < 100) {
            toggleMenu();
        }
        
        isSidebarSwipeActive = false;
    }

    // Initialize sidebar touch events
    const menuOverlay = document.getElementById('menuOverlay');
    const menuBackdrop = document.getElementById('menuBackdrop');
    
    menuOverlay.addEventListener('touchstart', handleSidebarTouchStart, { passive: false });
    menuOverlay.addEventListener('touchmove', handleSidebarTouchMove, { passive: false });
    menuOverlay.addEventListener('touchend', handleSidebarTouchEnd, { passive: false });
    
    menuBackdrop.addEventListener('touchstart', function(e) {
        e.preventDefault();
    }, { passive: false });
    
    menuBackdrop.addEventListener('touchend', function(e) {
        e.preventDefault();
        if (isMenuOpen) {
            toggleMenu();
        }
    }, { passive: false });

    // Category navigation touch support
    let categoryTouchStartX = 0;
    let isCategorySwipeActive = false;

    document.getElementById('categoryContainer').addEventListener('touchstart', function(e) {
        const touch = e.touches[0];
        categoryTouchStartX = touch.clientX;
        isCategorySwipeActive = true;
    }, { passive: false });

    document.getElementById('categoryContainer').addEventListener('touchmove', function(e) {
        if (!isCategorySwipeActive) return;
        // Allow native scrolling behavior
    }, { passive: true });

    document.getElementById('categoryContainer').addEventListener('touchend', function(e) {
        isCategorySwipeActive = false;
        setTimeout(updateScrollIndicators, 100);
    }, { passive: true });

    // Initialize scroll indicators on load
    window.addEventListener('load', function() {
        updateScrollIndicators();
        
        // Welcome message
        setTimeout(() => {
            showNotification('Enhanced topbar with categories ready! üéâ');
        }, 500);
    });

    // Handle container scroll for indicator updates
    document.getElementById('categoryContainer').addEventListener('scroll', function() {
        updateScrollIndicators();
    });

    // Handle window resize
    window.addEventListener('resize', function() {
        setTimeout(updateScrollIndicators, 100);
    });

    // Prevent menu from opening when clicking search area
    document.querySelector('.search-bar').addEventListener('click', function(e) {
    e.stopPropagation();
    });

</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
  import { getFirestore, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDii92erBDqj58did_0cwOoHIhw5OO3WVQ",
    authDomain: "kskids-7740b.firebaseapp.com",
    projectId: "kskids-7740b",
    storageBucket: "kskids-7740b.firebasestorage.app",
    messagingSenderId: "1061159747962",
    appId: "1:1061159747962:web:0c9f7463e7107a680a56c3",
    measurementId: "G-Y857VG4YYZ"
    };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  // Make db available globally
  window.db = db;
  window.firestoreFunctions = { collection, getDocs, onSnapshot };
</script>

</body>
</html>
